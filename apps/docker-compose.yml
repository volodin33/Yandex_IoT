name: smarthome
 
services:
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./smart_home/init.sql:/docker-entrypoint-initdb.d/001-init.sql:ro
    ports:
      - "5432:5432"
    networks:
      - smarthome-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 5s
      timeout: 3s
      retries: 15
  
  rabbitmq:
    image: rabbitmq:4.2.1-management-alpine
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - smarthome-network
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: smarthome-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    networks:
      - smarthome-network
 
  app:
    build:
      context: ./smart_home
      dockerfile: Dockerfile
    container_name: smarthome-app
    depends_on:
      postgres:
        condition: service_healthy
      temperature-api:
        condition: service_started
    environment:
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/smarthome
      - TEMPERATURE_API_URL=http://temperature-api:8081
      - INTEGRATION_API_URL=http://integration-api:5060
    ports:
      - "8080:8080"
    networks:
      - smarthome-network
    restart: unless-stopped
    
  temperature-api:
    build:
      context: ./smart_home/dotnet-services
      dockerfile: temperature-api/Dockerfile
    container_name: temperature-api
    environment:
      - ASPNETCORE_URLS=http://0.0.0.0:8081
    ports:
      - "8081:8081"
    networks: 
      - smarthome-network
    restart: unless-stopped
    
  integration-api:
    build:
      context: ./smart_home/dotnet-services
      dockerfile: LegacyIntegrationApi/Dockerfile
    container_name: integration-api
    environment:
      - ASPNETCORE_URLS=http://0.0.0.0:5060
    ports:
      - "5060:5060"
    networks: 
      - smarthome-network
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
        
  device-registry:
    build:
      context: ./smart_home/dotnet-services
      dockerfile: DeviceRegistry/Dockerfile 
    container_name: device-registry
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:5010
      ConnectionStrings__Db: "Host=postgres;Port=5432;Database=device_registry;Username=postgres;Password=postgres"
      ConnectionStrings__RabbitMq: "amqp://guest:guest@rabbitmq:5672"
      IS_DEMO_MODE: "true"
    ports:
      - "5010:5010"
    networks: 
      - smarthome-network
    restart: unless-stopped
    healthcheck:
      test: curl --fail http://localhost:5010/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
        
  router:
    build:
      context: ./smart_home/dotnet-services
      dockerfile: Router/Dockerfile 
    container_name: Router
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:5020
      ConnectionStrings__RabbitMq: "amqp://guest:guest@rabbitmq:5672"
      ConnectionStrings__DeviceRegistry: "http://device-registry:5010"
    ports:
      - "5020:5020"
    networks: 
      - smarthome-network
    restart: unless-stopped
    depends_on:
      device-registry:
        condition: service_healthy
        
  telemetry-service:
    build:
      context: ./smart_home/dotnet-services
      dockerfile: TelemetryService/Dockerfile 
    container_name: telemetry-service
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:5030
      ConnectionStrings__Db: "Host=postgres;Port=5432;Database=device_registry;Username=postgres;Password=postgres"
      ConnectionStrings__RabbitMq: "amqp://guest:guest@rabbitmq:5672"
      IS_DEMO_MODE: "true"
    ports:
      - "5030:5030"
    networks: 
      - smarthome-network
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    
  flow-service:
    build:
      context: ./smart_home/dotnet-services
      dockerfile: FlowService/Dockerfile 
    container_name: flow-service
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:5040
      ConnectionStrings__Db: "Host=postgres;Port=5432;Database=device_registry;Username=postgres;Password=postgres"
      ConnectionStrings__RabbitMq: "amqp://guest:guest@rabbitmq:5672"
      IS_DEMO_MODE: "true"
    ports:
      - "5040:5040"
    networks: 
      - smarthome-network
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
  
volumes:
  postgres_data:
  rabbitmq_data:

networks:
  smarthome-network:
    driver: bridge